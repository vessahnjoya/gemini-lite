[
    {
        "type": "client",
        "name": "Reject status codes above 59",
        "url": "gemini-lite://localhost/high-status-code",
        "input": false,
        "transactions": [
            {
                "url": "gemini-lite://localhost/high-status-code",
                "reply": "70 Not Allowed\r\n"
            }
        ],
        "exitcode": 1,
        "stdout": "",
        "justification": "Status codes MUST be between 10 and 59 as per project manual. A client SHOULD reject any status code greater than 59. Here the server sends 60, so the client must treat this as a protocol syntax error and exit with error code 1, with nothing inside stdout."
    },
    {
        "type": "client",
        "name": "Reject status codes below 10",
        "url": "gemini-lite://localhost/low-status-code",
        "input": false,
        "transactions": [
            {
                "url": "gemini-lite://localhost/low-status-code",
                "reply": "09 Weird status\r\n"
            }
        ],
        "exitcode": 1,
        "stdout": "",
        "justification": "Status codes MUST be between 10 and 59 as per project manual. A client SHOULD reject any status code less than 10 . Here the server sends 09, so the client must treat this as a protocol syntax error and exit with error code 1, with nothing inside stdout."
    },
    {
        "type": "client",
        "name": "Redirect followed by success",
        "url": "gemini-lite://localhost:1958/redirect",
        "input": false,
        "transactions": [
            {
                "url": "gemini-lite://localhost:1958/redirect",
                "reply": "30 gemini-lite://localhost:1958/target\r\n"
            },
            {
                "url": "gemini-lite://localhost:1958/target",
                "reply": "20 text/gemini\r\ncontent\r\n"
            }
        ],
        "exitcode": 0,
        "stdout": "content\r\n",
        "justification": "Client MUST redirect if given a status code 30, in this case it should redirect 1 time. Hnece this test cases verifies redirect support. This is required by Gemini specification, section 'Redirection' of https://geminiprotocol.net/docs/protocol-specification.gmi which requires redictions"
    },
    {
        "type": "client",
        "name": "usage of user input",
        "url": "gemini-lite://localhost:1958/search",
        "input": "what is gemini protocol",
        "transactions": [
            {
                "url": "gemini-lite://localhost:1958/search",
                "reply": "10 Enter search query\r\n"
            },
            {
                "url": "gemini-lite://localhost:1958/search?what%20is%20gemini%20protocol",
                "reply": "20 text/gemini\r\n# Search Results\r\n\r\nYour query: what is gemini protocol\r\n\r\n=> /about/gemini protocol More about gemini protocol\r\n"
            }
        ],
        "exitcode": 0,
        "stdout": "# Search Results\r\n\r\nYour query: what is gemini protocol\r\n\r\n=> /about/gemini protocol More about gemini protocol\r\n",
        "justification": "Tests correct handling of status code 10. When a second command-line argument is provided, a client MUST use it as the input value. The client MUST encode spaces as '%20'. It MUST append the encoded input as a new query, replacing any existing query even if the original URL had one. This is required by the Gemini specification, section on 'Input expected' of https://geminiprotocol.net/docs/protocol-specification.gmi"
    },
    {
        "type": "server",
        "name": "Reject overlong request URI > 1024 bytes",
        "documents": {
            "index.gmi": "# Hello\r\n"
        },
        "request": "gemini-lite://localhost/aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\r\n",
        "reply_regex": "^59( .*)?$",
        "body": "",
        "justification": "The request line URI must not exceed the maximum length specified in the protocol under section Requests section of https://geminiprotocol.net/docs/protocol-specification.gmi . This request uses a very long path, so the server should treat it as a bad request and respond with an error status 59 and an empty body."
    },
    {
        "type": "server",
        "name": "Reject URI with userinfo component",
        "documents": {
            "index.gmi": "# Hello\r\n"
        },
        "request": "gemini-lite://user@localhost/\r\n",
        "reply_regex": "^59( .*)?$",
        "body": "",
        "justification": "Gemini URIs must not contain a userinfo component. The request URI includes 'user@' before the host, so the server must reject it and return an error response with code 59 and no body as writen in the 'overview' section of https://geminiprotocol.net/docs/protocol-specification.gmi"
    },
    {
        "type": "server",
        "name": "Reject URI containing a fragment",
        "documents": {
            "index.gmi": "# Root\r\n"
        },
        "request": "gemini-lite://localhost/path#fragment\r\n",
        "reply_regex": "^59( .*)?$",
        "body": "",
        "justification": "Clients must not send a fragment identifier to the server as specified under the requests section of https://geminiprotocol.net/docs/protocol-specification.gmi . When a request URI contains a fragment, the server should treat it as invalid and respond with a 59 error and an empty body."
    },
    {
        "type": "server",
        "name": "serve nested file path",
        "documents": {
            "docs/blabla.gmi": "# Data inside Nested file\r\n"
        },
        "request": "gemini-lite://localhost/docs/blabla.gmi\r\n",
        "reply_regex": "^20 text/gemini.*$",
        "body": "# Data inside Nested file\r\n",
        "justification": "From the official gemini protocol specification, if the request URI path points directly to a .gmi file whether its in root directory or subfolder, the server should return the contents of that file with a status code of 20 and media type text/gemini  "
    },
    {
        "type": "proxy",
        "name": "Unrecognized request",
        "request": "gemini-lite://localhost/resource\r\n",
        "server_transactions": [
            {
                "url": "gemini-lite://localhost/resource",
                "reply": "44 Slow down\r\n"
            },
            {
                "url": "gemini-lite://localhost/resource",
                "reply": "20 text/plain\r\nOk"
            }
        ],
        "reply_regex": "^20 text/plain$",
        "body": "OK",
        "justification": "When the server responds with a 44 slow-down status, the proxy must not hide or reinterpret it. The proxy should backoff then retry once, and relay the final reply (status line) and its body to the client as specified under the status codes section of https://geminiprotocol.net/docs/protocol-specification.gmi ."
    },
    {
        "type": "proxy",
        "name": "Relay sensitive-input request responses to the client",
        "request": "gemini-lite://localhost/login\r\n",
        "server_transactions": [
            {
                "url": "gemini-lite://localhost/login",
                "reply": "11 Enter password\r\n"
            }
        ],
        "reply_regex": "^11 Enter password$",
        "body": "",
        "justification": "Status code 11 represents sensitive input where the server requests input that must not be echoed such as a password. The proxy should only relay the status and meta to its client, with no body so the client can present a non echoing prompt as specified under the status codes section of https://geminiprotocol.net/docs/protocol-specification.gmi ."
    }
]